// ==UserScript==
// @name        Better Gatry
// @description Make Gatry great.
// @match       *://gatry.com/*
// ==/UserScript==

{var BTTG_CAN_FETCH=!1;const t="0.0.4";console.log("%c%s","background:#ff3375;color:#ffffff","   ___   _ _____ _____   __   \n  / __| /_\\_   _| _ \\ \\ / /   \n | (_ |/ _ \\| | |   /\\ V /    \n  \\___/_/ \\_\\_| |_|_\\ |_|     \n                              "),console.log("%c%s","color:#ff3375",`      ...but better! (v${t})`);const e={gatry:"admin"};try{fetch("https://cdn.jsdelivr.net/gh/Gataquadrada/better-gatry@latest/verified-users.json").then((t=>{BTTG_CAN_FETCH=!0,t.json().then((t=>{t.users.forEach((t=>{"gatry"!==t.user&&(e[t.user]=t.badge)}))}))}))}catch(t){console.log("Not possible to use the fetch() API...")}const o={helped:!1,darkmode:!0,rich_links:!1,users:[]},n='<style id="bttg-dark-mode">\n\t\t:root{\n\t\t\t--bttg-color-bg: #222831;\n\t\t\t--bttg-color-fg: #393E46;\n\t\t\t--bttg-color-bc: #343a40;\n\t\t\t--bttg-color-fc: #cccccc;\n\t\t}\n\t\t:root.bttg-dark-mode body{\n\t\t\t--fancybox-content-bg: var(--bttg-color-fg);\n\t\t\t--fancybox-content-color: var(--bttg-color-fc);\n\t\t}\n\t\t.bttg-btn-dark-mode{\n\t\t\tbackground: #f27474;\n\t\t}\n\t\t.bttg-dark-mode .bttg-btn-dark-mode{\n\t\t\tbackground: #495057;\n\t\t}\n\t\t.bttg-dark-mode .bttg-btn-dark-mode .bttg-is-sun,\n\t\t.bttg-btn-dark-mode .bttg-is-moon{\n\t\t\tdisplay: none;\n\t\t}\n\t\t.bttg-btn-dark-mode .bttg-is-sun,\n\t\t.bttg-dark-mode .bttg-btn-dark-mode .bttg-is-moon{\n\t\t\tdisplay: inline-block;\n\t\t}\n\t\t.bttg-dark-mode body{\n\t\t\tbackground: var(--bttg-color-bg);\n\t\t\tcolor: var(--bttg-color-fc);\n\t\t}\n\t\t.bttg-dark-mode .top-bar{\n\t\t\tbackground: var(--bttg-color-bg);\n\t\t}\n\t\t.bttg-dark-mode .top-bar .menu ul li a {\n\t\t\tcolor: var(--bttg-color-fc);\n\t\t}\n\t\t.bttg-dark-mode .top-bar .header,\n\t\t.bttg-dark-mode .top-bar .header .wrapper-header .share,\n\t\t.bttg-dark-mode .top-bar .menu{\n\t\t\tborder-color: var(--bttg-color-bc);\n\t\t} \n\t\t.bttg-dark-mode .comments{\n\t\t\tborder-radius: 10px;\n\t\t\toverflow: hidden;\n\t\t}\n\t\t.bttg-dark-mode .page .no-data, \n\t\t.bttg-dark-mode .comments .comment, \n\t\t.bttg-dark-mode .comments.comments-user .comment .comment-wrapper{\n\t\t\tbackground: var(--bttg-color-fg);\n\t\t\tborder-color: var(--bttg-color-bc);\n\t\t}\n\t\t.bttg-dark-mode .comments .comment .comment-header a{\n\t\t\tcolor: #eeeeee;\n\t\t}\n\t\t.bttg-dark-mode .comments .comment .comment-header .comment-time b{\n\t\t\tbackground: rgba(50 100 150 / 0.4);\n\t\t}\n\t\t.bttg-dark-mode .btn-criar-alerta{\n\t\t\tbackground: var(--bttg-color-fg);\n\t\t\tcolor: var(--bttg-color-fc);\n\t\t}\n\t\t.bttg-dark-mode .search-bar{\n\t\t\tbackground: var(--bttg-color-fg);\n\t\t\tborder-color: var(--bttg-color-fg);\n\t\t\tborder-radius: 10px;\n\t\t}\n\t\t.bttg-dark-mode .search-bar [type="text"]{\n\t\t\tbackground: none;\n\t\t\tcolor: #fff;\n\t\t}\n\t\t.bttg-dark-mode .promotions article{\n\t\t\tbackground: var(--bttg-color-fg);\n\t\t\tborder-radius: 10px;\n\t\t\tcolor: var(--bttg-color-fc);\n\t\t}\n\t\t.bttg-dark-mode .promotions article .description h3 a{\n\t\t\tcolor: #ccc;\n\t\t}\n\t\t.bttg-dark-mode .promotions article .description .price,\n\t\t.bttg-dark-mode .promotions article .options .option-other p, \n\t\t.bttg-dark-mode .promotions article .image p{\n\t\t\tcolor: #ccc;\n\t\t}\n\t\t.bttg-dark-mode .promotions article .image img{\n\t\t\tfilter: contrast(1);\n\t\t\tmix-blend-mode: multiply;\n\t\t}\n\t\t.bttg-dark-mode .load-more button{\n\t\t\tbackground: var(--bttg-color-fg);\n\t\t\tborder-radius: 10px;\n\t\t\tcolor: var(--bttg-color-fc);\n\t\t}\n\t\t.bttg-dark-mode footer{\n\t\t\tbackground: var(--bttg-color-bg);\n\t\t}\n\t\t.bttg-dark-mode .tribute-container ul{\n\t\t\tbackground: var(--bttg-color-bg);\n\t\t\tborder-color: var(--bttg-color-bg);\n\t\t}\n\t\t.bttg-dark-mode .tribute-container ul .highlight{\n\t\t\tbackground: var(--bttg-color-bc);\n\t\t}\n\t\t.comments .comment .comment-wrapper:hover .comment-header [data-bttg-user-block] {\n\t\t\tdisplay: block !important;\n\t\t}\n\t\t</style>';document.head.innerHTML+=n;try{var mySettings=JSON.parse(localStorage.getItem("bttg_mysettings")??JSON.stringify({}));mySettings={helped:!1,darkmode:!0,users:[],...mySettings},o.helped=mySettings.helped,o.darkmode=mySettings.darkmode,o.rich_links=mySettings.rich_links,o.users=mySettings.users}catch(t){console.error(t)}const a=()=>o,r=({helped:t=null,darkmode:e=null,rich_links:n=null,users:a=null,_callback:r=(()=>{}),_autosave:i=!1}={helped:null,darkmode:null,rich_links:null,users:null,_callback:()=>{},_autosave:!1})=>{o.helped=null!==t?t:o.helped,o.darkmode=null!==e?e:o.darkmode,o.rich_links=null!==n?n:o.rich_links,o.users=null!==a?a:o.users,i?s({_callback:r()}):r()},s=({_callback:t=(()=>{})}={_callback:()=>{}})=>{localStorage.setItem("bttg_mysettings",JSON.stringify(o))},i=()=>a().users,c=(t="")=>{const e=i();e.push(t),r({users:[...new Set(e)],_autosave:!0,_callback:()=>{p()}})},d=(t="")=>{var e=i();e=e.filter((function(e){return e!==t})),r({users:[...new Set(e)],_autosave:!0,_callback:()=>{setTimeout((()=>{console.log("Bye!"),window.location.reload()}),1e3)}})},l=()=>{document.getElementsByTagName("html")[0].classList.add("bttg-dark-mode")},p=()=>{const t=i();$(".comment-wrapper").each((function(){const n=$(this),a=n.find(".comment-header").first(),r=a.find("a").attr("href").toString().toString().toLowerCase().split("/").slice(-1)[0];if(t.includes(r)&&!window.location.href.toString().toLowerCase().includes(`detalhe/${r}`))return n.parent().remove(),null;if(o.rich_links&&$(".comment-content:not([data-bttg-rich-loaded])").each((function(){$(this).attr("data-bttg-rich-loaded",!0).find("a").each((function(){const t=$(this),e=t.attr("href"),o=e.split(".").slice(-1),n=$("<a>",{href:e,target:"_blank",class:"media p-2 rounded bg-secondary text-light"}),a=$("<h6>",{class:"mt-0 mb-1",text:"Loading..."}),r=$("<span>",{text:"Loading preview..."}),s=$("<img>",{src:"https://placekitten.com/36/36",css:{height:"36px",inset:"0px",margin:"auto","max-width":"100px",position:"abbsolute"}});["gif","jpg","jpeg","png"].includes(o)?(s.attr("src",e),a.remove(),r.text(e),n.insertAfter(t)):(n.append($("<div>",{class:"mr-2",css:{height:"36px",overflow:"hidden",position:"relative",width:"36px"}}).append(s)).append($("<div>",{class:"media-body"}).append(a).append(r)),fetch(`https://favorited-link-preview.herokuapp.com/api/link-preview?url=${encodeURIComponent(e)}`).then((e=>{e.json().then((e=>{e?.result?.siteData?(e.result.siteData?.image&&s.attr("src",e.result.siteData.image),e.result.siteData?.title&&a.text(e.result.siteData.title),e.result.siteData?.description&&r.text(e.result.siteData.description),n.insertAfter(t)):n.remove()})).catch((t=>{console.log("No fetch allowed..."),n.remove()}))})).catch((t=>{console.log("No fetch allowed..."),n.remove()})))}))})),n.find("[data-bttg-user-block]").length)return null;const s=$("<a>",{href:"#","data-bttg-user-block":r,css:{color:"coral",float:"right","margin-left":"7px",display:"none"},html:'<i class="fa fa-ban"></i>'}).on("click",(function(t){if(t.stopImmediatePropagation(),t.preventDefault(),"desireeoficial"==r)return alert("Eu crio o script e você tenta usar contra mim?"),alert("Imbecil."),null;c(r)})),i=n.find(".comment-report");if(s.insertBefore(i),e[r]){$("<img>",{src:`https://cdn.jsdelivr.net/gh/Gataquadrada/better-gatry@latest/assets/badge_${e[r]}.png`,css:{height:"15px",width:"15px"}}).insertBefore(a.find(".text-gray").first())}}))},g=()=>{var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(JSON.stringify(a()))),t.setAttribute("download","settings.bttg"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)},m=()=>new Promise(((t,e)=>{if("undefined"!=typeof FileReader){const o=$("<input/>",{type:"file",accept:".bttg"});o.on("change",(function(){const o=$(this),n=new FileReader;n.onload=function(o){try{const e=JSON.parse(o.target.result);t(e)}catch(t){e("Não foi possível carregar suas configurações...")}},n.readAsText(o[0].files[0])})),o.trigger("click")}else alert("Your system doesn't support offline file manipulation...")}));o.darkmode&&l(),window.addEventListener("load",(()=>{const e=$("<div>",{css:{"align-items":"center",display:"flex","flex-direction":"column",gap:"5px","justify-content":"center"}}).appendTo($("section.top-bar .header .container .wrapper-header")),n=$("<a>",{href:"#",css:{"align-items":"center",background:"#ff338b","border-radius":"100%",color:"white",display:"flex","font-size":"13px",height:"20px","justify-content":"center",opacity:".9",width:"20px"}}).on("click",(function(e){e.stopImmediatePropagation(),e.preventDefault();const n=setInterval((()=>{if($("[data-bttg-settings-window-container]").is(":visible")){const t=$("<div>",{"data-bttg-settings-window":!0}).appendTo($("[data-bttg-settings-window-container]"));t.on("click","[data-bttg-tab]",(function(t){t.stopImmediatePropagation(),t.preventDefault(),$("[data-bttg-tab]").removeClass("active"),$(this).addClass("active"),$("[data-bttg-tab-content]").addClass("d-none"),$(`[data-bttg-tab-content="${$(this).data("bttg-tab")}"]`).removeClass("d-none")}));const e=$("<div>",{class:"list-group"}).appendTo(t),s=$("<a>",{href:"#",class:"list-group-item list-group-item-action p-2 "+(mySettings.helped?"active":""),"data-bttg-tab":"settings-general",text:"Geral"}).appendTo(e),c=$("<div>",{class:"mb-5"}).append($("<h6>",{text:"Preferências",css:{"font-weight":"600","font-size":"16px"}})).append($("<div>",{class:"custom-control custom-switch"}).append($("<input>",{type:"checkbox",class:"custom-control-input",id:"bttg-checkbox-settings-rich-links",checked:o.rich_links}).on("change",(function(){const t=$(this).is(":checked");r({rich_links:t,_autosave:!0})}))).append($("<label>",{class:"custom-control-label",for:"bttg-checkbox-settings-rich-links",text:"Pré-visualizar links em comentários."}).append($("<div>",{class:"form-text text-muted",text:"(Depende de ferramenta de terceiros)"})))),l=$("<div>").append($("<h6>",{text:"Usuários bloqueados",css:{"font-weight":"600","font-size":"16px"}})),p=$("<div>",{text:"Você não possui usuários bloqueados."}).appendTo(l),b=i();b.length&&(p.empty(),$.each(b,((t,e)=>{p.append($("<div>",{class:"form-group form-check"}).append($("<input>",{type:"checkbox",class:"form-check-input",id:`bttg-checkbox-${e}`,checked:!0}).on("change",(function(){d(e)}))).append($("<label >",{class:"form-check-label",for:`bttg-checkbox-${e}`,text:e})))})),p.children().last().addClass("m-0"));const u=$("<div>",{class:"d-none","data-bttg-tab-content":"settings-general"}).append(c).append(l),h=($("<a>",{href:"#",class:"list-group-item list-group-item-action p-2 "+(mySettings.helped?"":"active"),"data-bttg-tab":"settings-backup",text:"Backup"}).appendTo(e),$("<div>",{class:"d-none","data-bttg-tab-content":"settings-backup"}).append($("<button>",{type:"button",class:"btn btn-primary btn-block mb-3",text:"Salvar configurações"}).on("click",(function(t){t.stopImmediatePropagation(),t.preventDefault(),g()}))).append($("<button>",{type:"button",class:"btn btn-outline-danger btn-sm btn-block m-0",text:"Carregar configurações"}).on("click",(function(t){t.stopImmediatePropagation(),t.preventDefault();const e=$(this);m().then((t=>{e.addClass("disabled"),r({helped:t.helped??!1,darkmode:t.darkmode??!1,rich_links:t.rich_links??!1,users:t.users??[],_autosave:!0,_callback:()=>{setTimeout((()=>{console.log("Bye!"),window.location.reload()}),1e3)}})})).catch((t=>{e.removeClass("disabled"),alert(t)}))})))),f=$("<a>",{href:"#",class:"list-group-item list-group-item-action p-2 "+(mySettings.helped?"":"active"),"data-bttg-tab":"settings-help",text:"Ajuda"}).appendTo(e),k=$("<div>",{class:"d-none","data-bttg-tab-content":"settings-help"}).append($("<p>",{html:'- Clique em (<i class="fab fa-simplybuilt"></i>) para abrir este menu.'})).append($("<p>",{text:'- Posicione o mouse sobre um comentário, para exibir os botões "Reportar" e "Bloquear".'})).append($("<p>",{text:"- As configurações serão salvas no seu navegador (e somente ele)."})).append($("<p>",{text:"- Se você gostou da iniciativa, agradeça não sendo um completo imbecil."})).append($("<p>",{html:'- Sugestões? <a href="https://gatry.com/usuarios/detalhe/desireeoficial">Meu perfil</a>.',class:"m-0"}));t.append($("<div>",{class:"row no-gutters"}).append($("<div>",{class:"col-12 col-md-4 pr-md-2 mt-2"}).append(e)).append($("<div>",{class:"col-12 col-md-8 mt-2"}).append($("<div>",{class:"border rounded p-2",css:{"font-size":"14px","text-align":" left"}}).append(u).append(h).append(k)))),a().helped?s.trigger("click"):(f.trigger("click"),r({helped:!0,_autosave:!0})),clearInterval(n)}}),100);Swal.fire({title:`Better Gatry ${t}`,html:'<div data-bttg-settings-window-container="true"></div>',type:null})})).appendTo(e).append($("<i>",{class:"fab fa-simplybuilt"}));a().helped||n.trigger("click");$("<a>",{href:"#",class:"bttg-btn-dark-mode",css:{"align-items":"center","border-radius":"100%",color:"white",display:"flex","font-size":"10px",height:"20px","justify-content":"center",opacity:".9",width:"20px"}}).on("click",(function(t){t.stopImmediatePropagation(),t.preventDefault(),$("html").toggleClass("bttg-dark-mode"),r({darkmode:!a().darkmode,_autosave:!0})})).append($("<i>",{class:"fa fa-star bttg-is-sun"})).append($("<i>",{class:"fa fa-moon bttg-is-moon"})).appendTo(e);p(),$(document).off("click","[data-lightbox-comments]"),$(document).on("click","[data-lightbox-comments]",(function(t){t.stopImmediatePropagation(),t.preventDefault();var e=$(this).prop("href");new Fancybox([{type:"ajax",src:e}],{mainClass:"fancybox-gatry fancybox-gatry-comment",on:{loaded:p,ready:p,done:p}})}));var s=!1,c=!1;$(".load-more button").off("click"),$(document).on("click",".load-more button",(function(t){if(t.stopImmediatePropagation(),t.preventDefault(),c=!0,!s){s=!0;var e=$(this),o=$(this).data("url"),n=$(this).data("appendLocal"),a=$(this).data("finishText")||"Todos os registros foram exibidos",r=$(this).data("exclude")||null,i=parseInt($(this).data("currentPage"))+1,d=document.documentElement.scrollTop;e.html("Carregando, aguarde..."),$.get(o,{page:i,exclude:r},(function(t){if(0==t.length)return e.prop("disabled",!0),c=!1,void e.html(a);$(t).each((function(){const t=$(this);if($(this).find(".description h3").length){const e=$(this).find(".description h3").text().trim().split("\n");$(`article:contains("${e[0]}")`).length||$(n).append(t)}else if($(this).find(".comment-content").length){const e=$(this).find(".comment-content").text().trim().split("\n");$(`.comment:contains("${e[0]}")`).length||$(n).append(t)}})),e.data("currentPage",i),window.scrollTo(0,d),s=!1,e.html("Carregar mais..."),p()}))}})),$(window).on("scroll",(function(t){(c||$.browser.mobile)&&0!=$(".load-more button").length&&$(window).scrollTop()>=$(document).height()-$(window).height()-10&&$(".load-more button").click()}))}))}